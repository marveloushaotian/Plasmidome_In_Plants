// ===== Manifest =====
manifest {
  name            = 'Plant Plasmidome Analysis Pipeline'
  author          = 'HT Zheng'
  description     = 'Comprehensive plant bacterial genome analysis from assembly to phylogeny'
  mainScript      = 'main.nf'
  nextflowVersion = '>=23.04.0'
  version         = '1.2.0'
}

// ===== Global params =====
params {
  help       = false
  max_memory = '1000 GB'
  max_cpus   = 128
  max_time   = '999 h'

  outdir = 'Results'
  eggnog_db = '/dev/shm/eggnog_db/'
  
  // Quality thresholds
  length_threshold        = 1000
  coverage_threshold      = 20
  completeness_threshold  = 90.0
  contamination_threshold = 5.0
  
  // Bootstrap for IQ-TREE
  bootstrap_reps = 1000
  alrt_reps      = 1000
  
  // Prokka parameters
  prokka_kingdom = 'Bacteria'  // or 'Archaea'
  prokka_rfam = true
  
  // MOB-suite parameters
  mobsuite_db = null  // Optional: path to MOB-suite database if not using default

  // All the existing Conda environments（env://<name>）
  envs = [
    assembly       : '/home/qfh739/miniconda3/envs/spades_pipeline',  // 含 spades 与 bbmap
    quality_filter : '/home/qfh739/miniconda3/envs/spades_pipeline',  // reformat/bbmap/pileup/filterbyname
    genomad        : '/home/qfh739/miniconda3/envs/genomad',
    checkm         : '/home/qfh739/miniconda3/envs/checkm',
    checkm2        : '/home/qfh739/miniconda3/envs/checkm2',          // CheckM2 environment
    gtdbtk         : '/home/qfh739/miniconda3/envs/gtdbtk226',
    phylogeny      : '/home/qfh739/miniconda3/envs/gtdbtk226',        // Python 3 + gzip 即可
    iqtree         : '/home/qfh739/miniconda3/envs/iqtree2',
    mobsuite       : '/home/qfh739/miniconda3/envs/mobsuite',         // MOB-suite environment
    prokka         : '/home/qfh739/miniconda3/envs/prokka',           // Prokka environment
    prodigal       : '/home/qfh739/miniconda3/envs/prodigal',         // Prodigal environment
    eggnog         : '/home/qfh739/miniconda3/envs/eggnog',           // eggNOG-mapper environment
    padloc         : '/home/qfh739/miniconda3/envs/padloc',           // PADLOC environment
    defensefinder  : '/home/qfh739/miniconda3/envs/defensefinder',    // DefenseFinder environment
    cctyper        : '/home/qfh739/miniconda3/envs/cctyper',          // CCTyper environment
    amrfinder      : '/home/qfh739/miniconda3/envs/amrfinder',        // AMRFinder environment
    base           : '/home/qfh739/miniconda3'                        // awk/coreutils 场景
  ]
}

// ===== Profiles =====
profiles {
  standard {
    process {
      // Global concurrency and I/O settings
      queueSize = 256
      maxForks  = 64
      scratch   = true
      executor = 'local'
      shell    = ['/bin/bash', '-euo', 'pipefail']

      // ---- per-process resources & envs ----
      withName: ASSEMBLY            { cpus = 12;  memory = '64 GB';  conda = params.envs.assembly }
      withName: QUALITY_FILTER      { cpus = 12;  memory = '32 GB';  conda = params.envs.quality_filter }
      withName: GENOMAD             { cpus = 12;  memory = '64 GB';  conda = params.envs.genomad }
      withName: LABEL_CONTIGS       { cpus = 2;   memory = '4 GB';   conda = params.envs.base }
      withName: EXTRACT_CONTIG_MAPPING { cpus = 2;   memory = '8 GB';   conda = params.envs.base }
      withName: PREP_CHECKM_INPUTS  { cpus = 2;   memory = '4 GB';   conda = params.envs.base }
      withName: CHECKM_BATCH        { cpus = 108; memory = '512 GB'; conda = params.envs.checkm }
      withName: CHECKM_SINGLE       { cpus = 12;  memory = '64 GB';  conda = params.envs.checkm }
      withName: CHECKM2_SINGLE      { cpus = 12;  memory = '64 GB';  conda = params.envs.checkm2 }
      withName: MERGE_CHECKM_RESULTS { cpus = 1;  memory = '4 GB';   conda = params.envs.base }
      withName: FILTER_HQ_GENOMES   { cpus = 1;   memory = '2 GB';   conda = params.envs.base }
      withName: GTDBTK              { cpus = 128;  memory = '1300 GB'; conda = params.envs.gtdbtk }
      withName: GTDBTK_CLASSIFY_BATCH { maxForks = 10 }
      withName: PHYLOGENY           { cpus = 2;   memory = '8 GB';   conda = params.envs.phylogeny }
      withName: PHYLOGENY_GROUPED   { cpus = 2;   memory = '8 GB';   conda = params.envs.phylogeny }
      withName: IQTREE              { cpus = 30;  memory = '32 GB';  conda = params.envs.iqtree }
      withName: IQTREE_GROUPED      { cpus = 30;  memory = '32 GB';  conda = params.envs.iqtree }
      
      // MOB-suite processes
      withName: MOBSUITE_RECON     { cpus = 4;   memory = '16 GB';  conda = params.envs.mobsuite }
      withName: MOBSUITE_TYPER     { cpus = 2;   memory = '8 GB';   conda = params.envs.mobsuite }
      
      // Prokka processes
      withName: PROKKA_SANITIZE    { cpus = 2;   memory = '4 GB';   conda = params.envs.base }
      withName: PROKKA_ANNOTATE    { cpus = 8;   memory = '16 GB';  conda = params.envs.prokka }
      
      // Prodigal processes
      withName: PRODIGAL_PREDICT    { cpus = 4;   memory = '8 GB';   conda = params.envs.prodigal }
      
      // EggNOG processes
      withName: EGGNOG_DIAMOND     { cpus = 8;   memory = '16 GB';   conda = params.envs.eggnog }
      withName: EGGNOG_ANNOTATION  { cpus = 8;   memory = '16 GB';   conda = params.envs.eggnog }

      // PADLOC processes
      withName: PADLOC_ANNOTATE     { cpus = 4;   memory = '16 GB';   conda = params.envs.padloc }
      
      // DefenseFinder processes
      withName: DEFENSEFINDER_ANNOTATE  { cpus = 4;   memory = '16 GB';   conda = params.envs.defensefinder }
      
      // CCTyper processes
      withName: CCTYPER_ANNOTATE        { cpus = 2;   memory = '16 GB';   conda = params.envs.cctyper }
      
      // AMRFinder processes
      withName: AMRFINDER_ANNOTATE      { cpus = 4;   memory = '16 GB';   conda = params.envs.amrfinder }

      // Defense systems merger processes
      withName: COLLECT_GFF_FILES            { cpus = 2;   memory = '8 GB';    conda = params.envs.base }
      withName: COLLECT_PADLOC_RESULTS       { cpus = 1;   memory = '4 GB';    conda = params.envs.base }
      withName: COLLECT_DEFENSEFINDER_RESULTS{ cpus = 1;   memory = '4 GB';    conda = params.envs.base }
      withName: COLLECT_CCTYPER_RESULTS      { cpus = 1;   memory = '4 GB';    conda = params.envs.base }
      withName: MERGE_DEFENSE_SYSTEMS        { cpus = 4;   memory = '32 GB';   conda = params.envs.base }
      withName: DEFENSE_SUMMARY              { cpus = 1;   memory = '4 GB';    conda = params.envs.base }
    }

    conda.enabled       = true
    process.conda       = null       // 由 withName 指定 env://
    singularity.enabled = false
    docker.enabled      = false
    podman.enabled      = false
  }
  
  // Optional: HPC profile for SLURM clusters
  slurm {
    process {
      executor = 'slurm'
      queue    = 'normal'
      shell    = ['/bin/bash', '-euo', 'pipefail']
      
      // Same resource allocations as standard profile
      withName: ASSEMBLY            { cpus = 12;  memory = '64 GB';  time = '24h'; conda = params.envs.assembly }
      withName: QUALITY_FILTER      { cpus = 12;  memory = '32 GB';  time = '12h'; conda = params.envs.quality_filter }
      withName: GENOMAD             { cpus = 12;  memory = '64 GB';  time = '24h'; conda = params.envs.genomad }
      withName: LABEL_CONTIGS       { cpus = 2;   memory = '4 GB';   time = '2h';  conda = params.envs.base }
      withName: EXTRACT_CONTIG_MAPPING { cpus = 2;   memory = '8 GB';   time = '2h';  conda = params.envs.base }
      withName: PREP_CHECKM_INPUTS  { cpus = 2;   memory = '4 GB';   time = '2h';  conda = params.envs.base }
      withName: CHECKM_BATCH        { cpus = 108; memory = '512 GB'; time = '48h'; conda = params.envs.checkm }
      withName: CHECKM_SINGLE       { cpus = 12;  memory = '64 GB';  time = '6h';  conda = params.envs.checkm }
      withName: CHECKM2_SINGLE      { cpus = 12;  memory = '64 GB';  time = '6h';  conda = params.envs.checkm2 }
      withName: MERGE_CHECKM_RESULTS { cpus = 1;  memory = '4 GB';   time = '1h';  conda = params.envs.base }
      withName: FILTER_HQ_GENOMES   { cpus = 1;   memory = '2 GB';   time = '1h';  conda = params.envs.base }
      withName: GTDBTK              { cpus = 128;  memory = '1300 GB'; time = '24h'; conda = params.envs.gtdbtk }
      withName: GTDBTK_CLASSIFY_BATCH { maxForks = 10 }
      withName: PHYLOGENY           { cpus = 2;   memory = '8 GB';   time = '2h';  conda = params.envs.phylogeny }
      withName: PHYLOGENY_GROUPED   { cpus = 2;   memory = '8 GB';   time = '2h';  conda = params.envs.phylogeny }
      withName: IQTREE              { cpus = 30;  memory = '32 GB';  time = '24h'; conda = params.envs.iqtree }
      withName: IQTREE_GROUPED      { cpus = 30;  memory = '32 GB';  time = '24h'; conda = params.envs.iqtree }
      
      // MOB-suite processes
      withName: MOBSUITE_RECON     { cpus = 4;   memory = '16 GB';  time = '6h';  conda = params.envs.mobsuite }
      withName: MOBSUITE_TYPER     { cpus = 2;   memory = '8 GB';   time = '4h';  conda = params.envs.mobsuite }
      
      // Prokka processes
      withName: PROKKA_SANITIZE    { cpus = 2;   memory = '4 GB';   time = '2h';  conda = params.envs.base }
      withName: PROKKA_ANNOTATE    { cpus = 8;   memory = '16 GB';  time = '12h'; conda = params.envs.prokka }
      
      // Prodigal processes
      withName: PRODIGAL_PREDICT    { cpus = 4;   memory = '8 GB';   time = '4h';  conda = params.envs.prodigal }
      
      // EggNOG processes
      withName: EGGNOG_DIAMOND     { cpus = 8;   memory = '16 GB';  time = '12h'; conda = params.envs.eggnog }
      withName: EGGNOG_ANNOTATION  { cpus = 8;   memory = '16 GB';  time = '12h'; conda = params.envs.eggnog }
      
      // PADLOC processes
      withName: PADLOC_ANNOTATE     { cpus = 4;   memory = '8 GB';   time = '4h';  conda = params.envs.padloc }
      
      // DefenseFinder processes
      withName: DEFENSEFINDER_ANNOTATE  { cpus = 4;   memory = '16 GB';  time = '4h';  conda = params.envs.defensefinder }
      
      // CCTyper processes
      withName: CCTYPER_ANNOTATE        { cpus = 4;   memory = '16 GB';  time = '4h';  conda = params.envs.cctyper }
      
      // AMRFinder processes
      withName: AMRFINDER_ANNOTATE      { cpus = 4;   memory = '16 GB';  time = '4h';  conda = params.envs.amrfinder }

      // Defense systems merger processes
      withName: COLLECT_GFF_FILES            { cpus = 2;   memory = '8 GB';   time = '2h';  conda = params.envs.base }
      withName: COLLECT_PADLOC_RESULTS       { cpus = 1;   memory = '4 GB';   time = '1h';  conda = params.envs.base }
      withName: COLLECT_DEFENSEFINDER_RESULTS{ cpus = 1;   memory = '4 GB';   time = '1h';  conda = params.envs.base }
      withName: COLLECT_CCTYPER_RESULTS      { cpus = 1;   memory = '4 GB';   time = '1h';  conda = params.envs.base }
      withName: MERGE_DEFENSE_SYSTEMS        { cpus = 4;   memory = '32 GB';  time = '6h';  conda = params.envs.base }
      withName: DEFENSE_SUMMARY              { cpus = 1;   memory = '4 GB';   time = '1h';  conda = params.envs.base }
    }

    conda.enabled       = true
    singularity.enabled = false
    docker.enabled      = false
    podman.enabled      = false
  }
}

// ===== Reports =====
timeline {
  enabled   = true
  file      = "${params.outdir}/pipeline_info/timeline.html"
  overwrite = true
}
report {
  enabled   = true
  file      = "${params.outdir}/pipeline_info/report.html"
  overwrite = true
}
trace {
  enabled   = true
  file      = "${params.outdir}/pipeline_info/trace.txt"
  overwrite = true
}
dag {
  enabled   = true
  file      = "${params.outdir}/pipeline_info/dag.svg"
  overwrite = true
}

// ===== Resource caps (safety) =====
def check_max(obj, type) {
  if (type == 'memory') {
    try { return (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1) ? (params.max_memory as nextflow.util.MemoryUnit) : obj }
    catch(all) { println "### ERROR ### Max memory '${params.max_memory}' invalid; using ${obj}"; return obj }
  } else if (type == 'time') {
    try { return (obj.compareTo(params.max_time as nextflow.util.Duration) == 1) ? (params.max_time as nextflow.util.Duration) : obj }
    catch(all) { println "### ERROR ### Max time '${params.max_time}' invalid; using ${obj}"; return obj }
  } else if (type == 'cpus') {
    try { return Math.min(obj as int, params.max_cpus as int) }
    catch(all) { println "### ERROR ### Max cpus '${params.max_cpus}' invalid; using ${obj}"; return obj }
  }
}
